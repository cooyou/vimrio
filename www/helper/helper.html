<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<!--viゲームのHTML-->
<title>VIMRIO helper</title>
<script type="text/javascript" src="../jquery-1.12.3.min.js"></script> 
<style type="text/css">
*{
	margin:5px;
	padding:5px;
}

#hlptbl{
border-collapse: collapse;
border-style:solid;
border-width:1px;
border-color:white;
background-color:lightgray;
margin:0px;
padding:0px;
}
td{
border-color:white;
width:6px;
height:6px;
margin:0px;
padding:0px;
border-style:solid;
border-width:1px;
}
th{
border-color:white;
margin:0px;
padding:0px;
border-style:solid;
border-width:1px;
}

td span{
 font-size:8px;
}

#hlpansstr{
 font-size:12px;
 letter-spacing: 0.2em;
 width:100%;
 height:40px;
 box-sizing:border-box;
 wrap:off;
 word-break:break-all;
 white-space: normal;
}

.hlptag{
position:absolute;
}

.hlpwaitmsg{
background-color:yellow;
}

input{
  font-size:12px;
  letter-spacing: 0.3em;
}

.hlpcol{
	width:80px;
	height:20px;
	border-style:solid;
	border-width:1px;
	border-color:Ivory;
	display: inline-block;
}

.hlpcolstart{
	background-color:cyan;
}

.hlpcolroad{
	background-color:LawnGreen;
}

.hlpcolgoal{
	background-color:green;
}

.hlpcolwd1{
	border-color:black;
	background-color:white
}

.hlpcolwd2{
	background-color:gray
}
.hlpcolwall{
	background-color:Peru
}

.hlpcolwarn{
	background-color:yellow;
}

.hlprngwarn{
	width:240px;
	height:20px;
	border-style:solid;
	border-width:1px;
	border-color:yellow;
	background-color:yellow;
	display: inline-block;
	visibility:hidden;
}
.hlpcharwarn{
	width:240px;
	height:20px;
	border-style:solid;
	border-width:1px;
	border-color:yellow;
	background-color:yellow;
	display: inline-block;
	visibility:hidden;
}
</style>

<script  type="text/javascript">

function initHelper(){
  createHlpTable();
}

function createHlpTable(){
  var str="";
  var x,y;
  for(y=0;y<100;y++){
    str+="<tr>";
  	for(x=0;x<100;x++){
  	  str+="<td></td>";
  	}
  	str+="</tr>\n";
  }
  
  $('#hlptbl').html(str);
  
}

function drawBlock(no,name,x,y,u,color){
	var ix,iy;
	var xu,yu;
	xu=x*u;
	yu=y*u
	for(iy=0;iy<u;iy++){
		for(ix=0;ix<u;ix++){
			var prename=$("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).attr("name");
			var col=color;
			if(prename===name){
				col="yellow";
			}
			if(iy==0 && ix==0){
			  $("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).html('<span class="hlptag">'+no+'</span>');
			}
			$("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).attr("name",name);
	  		$("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).css("background-color",col);
	  		if(ix==0 || iy==0 || ix==u-1 || iy==u-1){
	  			$("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).css("opacity",0.9);
	  		}
	  		else{
	  			$("#hlptbl tr:eq(" + (yu+iy) + ") td:eq(" + (xu+ix) + ")" ).css("opacity",0.3);
	  		}
	  	}
	}
}

function isWall(x,y,u){
	var xu,yu;
	xu=x*u;
	yu=y*u;
	if(xu>=0 && xu<100 && yu>=0 && yu<100 && $("#hlptbl tr:eq(" + (yu) + ") td:eq(" + (xu) + ")" ).attr("name")!=""){
		return false;
	}
	if(xu-u>=0 && xu-u<100 && yu-u>=0 && yu-u<100 && $("#hlptbl tr:eq(" + (yu-u) + ") td:eq(" + (xu-u) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu>=0 && xu<100 && yu-u>=0 && yu-u<100 && $("#hlptbl tr:eq(" + (yu-u) + ") td:eq(" + (xu) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu+u>=0 && xu+u<100 && yu-u>=0 && yu-u<100 && $("#hlptbl tr:eq(" + (yu-u) + ") td:eq(" + (xu+u) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu-u>=0 && xu-u<100 && yu>=0 && yu<100 && $("#hlptbl tr:eq(" + (yu) + ") td:eq(" + (xu-u) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu+u>=0 && xu+u<100 && yu>=0 && yu<100 && $("#hlptbl tr:eq(" + (yu) + ") td:eq(" + (xu+u) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu-u>=0 && xu-u<100 && yu+u>=0 && yu+u<100 && $("#hlptbl tr:eq(" + (yu+u) + ") td:eq(" + (xu-u) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu>=0 && xu<100 && yu+u>=0 && yu+u<100 && $("#hlptbl tr:eq(" + (yu+u) + ") td:eq(" + (xu) + ")" ).attr("name")!=""){
		return true;
	}
	if(xu+u>=0 && xu+u<100 && yu+u>=0 && yu+u<100 && $("#hlptbl tr:eq(" + (yu+u) + ") td:eq(" + (xu+u) + ")" ).attr("name")!=""){
		return true;
	}

	return false;
}

function drawWordString(wordname,u,ary){
	var code="";
	var j;
	for(j=0;j<ary.length;j++){
		var info=ary[j];
		
		var x,y,w,h,line,wdlen;
		x=info[0];
		y=info[1];
		w=info[2];
		h=info[3];
		line=info[4];
		wdlen=info[5];
		
		var linelen=line.length;
		var i;
		for(i=0;i<linelen;i++){
		
			var nostr="02";
			var col1="lightgray";
			var col2="gray";
			if(i==0 || i==wdlen){
				nostr="01";
				col1="white";
				col2="white";
			}
			var wd=line.substr(i,1);
			
			code+="//word \""+line+"\" ["+wd+"] "+(i+1)+"\n";
			code+="item=stage.createNewItem();\n";
			code+="item.setName(\""+wordname+"\");\n";
			code+="item.addAnimation({\"dsp\":true,\"x\":"+(x+i)+"*u,\"y\":"+y+"*u,\"w\":u,\"h\":u,\"img\":\"word"+nostr+".png\",\"bgc\":\"transparent\",\"bdc\":\""+col1+"\",\"wd\":\""+wd+"\"});\n";
			code+="stage.addItem(item);\n";
			code+="\n";
			
			drawBlock(i+1,wordname,x+i,y,u,col2);
		}
	}
	return code;
}

function drawWall(wallname,u){
	var code="";
	var x,y;
	var ary=[];
	for(y=0;y*u<100;y++){
		for(x=0;x*u<100;x++){
			if(isWall(x,y,u)){
				ary.push([x,y]);
				code+="//wall "+ary.length+"\n";
				code+="item=stage.createNewItem();\n";
				code+="item.setName(\""+wallname+"\");\n";
				code+="item.addAnimation({\"dsp\":true,\"x\":"+x+"*u,\"y\":"+y+"*u,\"w\":u,\"h\":u,\"img\":\"brick01.png\",\"bgc\":\"BlanchedAlmond\",\"bdc\":\"peru\"});\n";
				code+="stage.addItem(item);\n";
				code+="\n";
			}
		}
	}
	
	var i;
	for(i=0;i<ary.length;i++){
		var x=ary[i][0];
		var y=ary[i][1];
		drawBlock(i+1,wallname,x,y,u,"Peru");
	}
	return code;
}

function createCode(){
  $('.hlpcodebtn').attr("disabled",true);
  $('.hlpwaitmsg').css("visibility","visible");
  setTimeout("createWorld()",100);

}

function getWordLength(str,i){
	var len=0;
	var i2=str.indexOf(" ",i+1);
	if(i2>0){
		len=i2-i;
	}
	else{
	  len=str.length;
	}
	//console.log("wordlen="+len);
	return len;
}

function getLineString(str,i){
	var d=str.substr(i,1);
	//console.log("d="+d);
	var i2=str.indexOf(d,i+1);
	if(i2<0){
	   i2=i+1;
	}
	
	var linelen=i2-i-1;
	var line=str.substr(i+1,linelen);
	//console.log("line="+line+" len="+i2);
	return line
}

function getAnsString(str){
  var ansstr="";
  var i;

  for(i=0;i<str.length;i++){

    var c=str.substr(i,1);
    ansstr+=c;

    
    if(c==='w'){
      i++;
      var d=str.substr(i,1);
      var j;
      i++;
      c="";
      for(;i<str.length;i++){
        c=str.substr(i,1);
        if(c===d){
          break;
         }
      }
 
    }
    
  }
  return ansstr;

}

function createWorld(){
  $("#hlptbl tr td").attr("name","");
  $("#hlptbl tr td").css("background-color","lightgray");
  $("#hlptbl tr td").css("opacity","1.0");
  $(".hlptag").parent("td").html("");
  var u=Number($('#hlpunitsize').val());
  var x0=Number($('#hlpx0').val());
  var y0=Number($('#hlpy0').val());
  
  var ansstr=$('#hlpansstr').val();

  var anslen=ansstr.length;
  var i;
  var x=x0;
  var y=y0;
  var vimrioname="vimrio";
  var goalname="goal";
  var wallname="wall";
  var wordname="word";
  
  var wordstringary=new Array();
  
  var code="//Created by VIMRIO helper\n\n";
  code+="//Please rename XXX.\n";
  code+="//For example. If current final stage is 012, this function's name is \"initStage013\" and save \"stage013.js\".\n";
  code+="function initStageXXX(stage){\n\n";
  code+="var item;\n";
  code+="var u="+u+";\n";
  var ans=getAnsString(ansstr);

  code+="stage.setAnsStr(\""+ans+"\");\n";
  code+="item=stage.createNewItem();\n";
  code+="item.setName(\""+vimrioname+"\");\n";
  code+="item.setFrameStartIndex(0);\n";
  code+="stage.addItem(item);\n";
  code+="//1 start\n";
  code+="item.addAnimation({\"dsp\":true,\"x\":"+x+"*u,\"y\":"+y+"*u,\"w\":u,\"h\":u,\"bgc\":\"transparent\",\"bdc\":\"blue\",\"img\":\""+vimrioname+"01.png\",\"z\":5,\"opc\":1.0});\n";
  var rngwarnflag=false;
  var charwarnflag=false;
  var roadno=1;
  if(x*u<0 || x*u>=100 || y*u<0 || y*u>=100){
  		rngwarnflag=true;
  }
  else{
		drawBlock(roadno,vimrioname,x,y,u,"cyan");
		roadno++;
		$('#hlptbl tr:eq('+y*u+') td:eq('+x*u+')').html("<span class='hlptag'>1 start</span>");
  }
  
  for(i=0;i<anslen;i++){
  
    var c=ansstr.substr(i,1);
   

    switch(c){
    	case 'h':	if((x-1)*u>=0 && (x-1)*u<100){
    					x-=1;
    					code+="//"+roadno+" h\n";
    					code+="item.addAnimation({\"x\":"+x+"*u});\n";
    				}
    				else{
    					rngwarnflag=true;
    				}
    				break;
    	case 'l':	if((x+1)*u>=0 && (x+1)*u<100){
    					x+=1;
    					code+="//"+roadno+" l\n";
    					code+="item.addAnimation({\"x\":"+x+"*u});\n";
    				}
    				else{
    					rngwarnflag=true;
    				}
    				break;
    	case 'j':	if((y+1)*u>=0 && (y+1)*u<100){
    					y+=1;
    					code+="//"+roadno+" j\n";
    					code+="item.addAnimation({\"y\":"+y+"*u});\n";
    				}
    				else{
    					rngwarnflag=true;
    				}
    				break;
    	case 'k':	if((y-1)*u>=0 && (y-1)*u<100){
    					y-=1;
    					code+="//"+roadno+" k\n";
    					code+="item.addAnimation({\"y\":"+y+"*u});\n";
    				}
    				else{
    					rngwarnflag=true;
    				}
    				break;
    	
    	case 'w':	var wdlen=getWordLength(ansstr,i+1);
    	
    				var xtmp=x;
    				if((x+wdlen)*u>=0 && (x+wdlen)*u<100){
    					x=x+wdlen;
    					code+="//"+roadno+" w\n";
    					code+="item.addAnimation({\"x\":"+x+"*u});\n";
    				}
    				else{
    					rngwarnflag=true;
    				}
    				var linestr=getLineString(ansstr,i+1);
    				i+=linestr.length+1;
    				wordstringary.push([xtmp,y,linestr.length,1,linestr,wdlen]);
    				break;
    				
    	default : charwarnflag=true;
    				break;
    }
    if(c!="w"){
	    if(i==anslen-1){
	    	drawBlock(1,vimrioname,x,y,u,"green");
	    	$('#hlptbl tr:eq('+y*u+') td:eq('+x*u+')').html("<span class='hlptag'>1 goal</span>");
	    }
	    else{
	    	drawBlock(roadno,vimrioname,x,y,u,"LawnGreen");
	    	roadno++;
	    }
	}

    
  }
  
  code+="\n";
  code+="//1 goal\n";
  code+="item=stage.createNewItem();\n";
  code+="item.setName(\""+goalname+"\");\n";
  code+="item.addAnimation({\"dsp\":true,\"x\":"+x+"*u,\"y\":"+y+"*u,\"w\":u,\"h\":u,\"img\":\"goal01.png\",\"bgc\":\"yellow\",\"bdc\":\"yellow\"});\n";
  code+="stage.addItem(item);\n";
  code+="\n";
  
  code+=drawWordString(wordname,u,wordstringary);
  code+="\n";
  
  code+=drawWall(wallname,u);
  code+="\n";
  

  
  code+="}\n";
  $('#hlpcodestr').val(code);
  $('.hlpcodebtn').attr("disabled",false);
  $('.hlpwaitmsg').css("visibility","hidden");
  
  if(rngwarnflag){
		$('.hlprngwarn').css("visibility","visible");
  }
  else{
  		$('.hlprngwarn').css("visibility","hidden");
  }
  if(charwarnflag){
  		$('.hlpcharwarn').css("visibility","visible");
  }
  else{
  		$('.hlpcharwarn').css("visibility","hidden");
  }
}

function dispIndex(){

    var index = $('#hlpansstr').get(0).selectionStart;
    
    $('.hlpindex').text("keyup cursor no="+(index+1));

}
</script>
</head>
<body onLoad="initHelper()">
<h4>VIMRIO helper for creator ver1.2.0</h4><br/>
unit size=<input type="text" id="hlpunitsize" value="10" size="4"/>[%]<br/>
start x=<input type="text" id="hlpx0" value="3" size="4"/>[unit]
 , y=<input type="text" id="hlpy0" value="4" size="4"/>[unit]<br/>
move and word string (support character= h j k l w ) example w --> w"test abc"<span class="hlpindex"></span><br/>
<textarea id="hlpansstr" onKeyUp="dispIndex()">hjjw"ab "w"cd ef"kkl</textarea><br/>
<input class="hlpcodebtn" type="button" onClick="createCode()" value="Create Code" /><span class="hlpwaitmsg" style="visibility:hidden">Please wait a minute.</span>
<br/>
<span class="hlpcol hlpcolstart">start</span><span class="hlpcol hlpcolroad">road</span><span class="hlpcol hlpcolgoal">goal</span><span class="hlpcol hlpcolwd1">word</span><span class="hlpcol hlpcolwd2">word</span><span class="hlpcol hlpcolwall">wall</span><span class="hlpcol hlpcolwarn">warning</span><br/>
<span class="hlprngwarn">warning draw range</span><span class="hlpcharwarn">warning not recognized character</span><br/>
<table id="hlptbl">
</table>
<p>code</p>
<textarea id="hlpcodestr" cols="80" rows="20">
</textarea>
</body>
</html>
